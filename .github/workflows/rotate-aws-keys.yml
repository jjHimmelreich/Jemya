name: ğŸ”„ AWS Key Rotation

on:
  schedule:
    # Run every 90 days at 2 AM UTC
    - cron: '0 2 */90 * *'
  workflow_dispatch: # Manual trigger
    inputs:
      force_rotation:
        description: 'Force key rotation'
        required: false
        default: 'false'

env:
  DEPLOYMENT_USER: jemya-github-actions

jobs:
  rotate-keys:
    name: ğŸ”‘ Rotate AWS Keys
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ• Set rotation timestamps
      run: |
        echo "ROTATION_DATE=$(date -u)" >> $GITHUB_ENV
        echo "NEXT_ROTATION=$(date -u -d '+90 days')" >> $GITHUB_ENV

    - name: âš™ï¸ Configure AWS credentials (old keys)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: ğŸ”‘ Create new access key
      id: new-key
      run: |
        # Create new access key
        NEW_KEY_OUTPUT=$(aws iam create-access-key \
          --user-name $DEPLOYMENT_USER \
          --output json)
        
        NEW_ACCESS_KEY=$(echo $NEW_KEY_OUTPUT | jq -r '.AccessKey.AccessKeyId')
        NEW_SECRET_KEY=$(echo $NEW_KEY_OUTPUT | jq -r '.AccessKey.SecretAccessKey')
        
        echo "new-access-key=$NEW_ACCESS_KEY" >> $GITHUB_OUTPUT
        echo "::add-mask::$NEW_SECRET_KEY"
        echo "new-secret-key=$NEW_SECRET_KEY" >> $GITHUB_OUTPUT

    - name: ğŸ§ª Test new credentials
      run: |
        # Test new credentials work
        AWS_ACCESS_KEY_ID="${{ steps.new-key.outputs.new-access-key }}" \
        AWS_SECRET_ACCESS_KEY="${{ steps.new-key.outputs.new-secret-key }}" \
        aws sts get-caller-identity

    - name: ğŸ”„ Update GitHub secrets
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Update repository secrets with new keys
        echo "${{ steps.new-key.outputs.new-secret-key }}" | \
        gh secret set AWS_SECRET_ACCESS_KEY --body-file -
        
        echo "${{ steps.new-key.outputs.new-access-key }}" | \
        gh secret set AWS_ACCESS_KEY_ID --body-file -

    - name: â±ï¸ Wait for secret propagation
      run: sleep 30

    - name: ğŸ—‘ï¸ Delete old access key
      run: |
        # Delete the old access key
        aws iam delete-access-key \
          --user-name $DEPLOYMENT_USER \
          --access-key-id ${{ secrets.AWS_ACCESS_KEY_ID }}

    - name: ğŸ§¹ Cleanup on failure
      if: failure() && steps.new-key.outputs.new-access-key
      run: |
        echo "ğŸš¨ Rotation failed - cleaning up new key"
        # Delete the new key we created if rotation failed
        aws iam delete-access-key \
          --user-name $DEPLOYMENT_USER \
          --access-key-id ${{ steps.new-key.outputs.new-access-key }} || true

    - name: ğŸ“Š Rotation summary
      run: |
        echo "## ğŸ”„ AWS Key Rotation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Status**: Successfully rotated AWS access keys" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“… **Date**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ‘¤ **User**: $DEPLOYMENT_USER" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ”‘ **New Key ID**: ${{ steps.new-key.outputs.new-access-key }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â° **Next rotation**: $(date -u -d '+90 days')" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ“§ Send success notification
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.NOTIFICATION_EMAIL }}
        password: ${{ secrets.NOTIFICATION_EMAIL_PASSWORD }}
        subject: "âœ… AWS Key Rotation Successful - Jemya Project"
        to: jenya.himmelreich@gmail.com
        from: ${{ secrets.NOTIFICATION_EMAIL }}
        body: |
          ğŸ”„ AWS Key Rotation Summary
          
          âœ… Status: Successfully rotated AWS access keys
          ğŸ“… Date: ${{ env.ROTATION_DATE }}
          ğŸ‘¤ User: ${{ env.DEPLOYMENT_USER }}
          ğŸ”‘ New Key ID: ${{ steps.new-key.outputs.new-access-key }}
          
          â° Next rotation scheduled: ${{ env.NEXT_ROTATION }}
          
          ğŸ”— View workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

    - name: ğŸ“§ Send failure notification
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.NOTIFICATION_EMAIL }}
        password: ${{ secrets.NOTIFICATION_EMAIL_PASSWORD }}
        subject: "âŒ AWS Key Rotation Failed - Jemya Project"
        to: jenya.himmelreich@gmail.com
        from: ${{ secrets.NOTIFICATION_EMAIL }}
        body: |
          ğŸš¨ AWS Key Rotation Failed
          
          âŒ Status: Key rotation encountered an error
          ğŸ“… Date: ${{ env.ROTATION_DATE }}
          ğŸ‘¤ User: ${{ env.DEPLOYMENT_USER }}
          
          Please check the workflow logs immediately and manually verify AWS access keys.
          
          ğŸ”— View workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          âš ï¸ Action required: Manual key rotation may be needed.